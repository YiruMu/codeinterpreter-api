from codeinterpreterapi import CodeInterpreterSession, File
from autogluon.cloud import TabularCloudPredictor
from langchain.tools import BaseTool
import pandas as pd
from typing import Optional

class AutoGluonTabular(BaseTool):
    name: str = "autogluon_tabular"
    description: str = "This tool uses Autogluon to solve both classification and regression machine learning problems that use tabular data."

    def _run(self, label_column: Optional[str] = None, train_dataset:Optional[str]=None, test_dataset:Optional[str]=None):
        raise NotImplementedError()

    async def _arun(self, label_column: Optional[str] = None, train_dataset:Optional[str]=None, test_dataset:Optional[str]=None):
        try: 
            train_data = pd.read_csv(train_dataset)
            test_data = pd.read_csv(test_dataset)
            predictor_init_args = {"label": label_column}  # init args you would pass to AG TabularPredictor
            predictor_fit_args = {"train_data": train_data, "time_limit": 120}  # fit args you would pass to AG TabularPredictor
            cloud_predictor = TabularCloudPredictor(cloud_output_path='s3://yiru-project/autogluon-cloud/')
            cloud_predictor.fit(predictor_init_args=predictor_init_args, predictor_fit_args=predictor_fit_args)
            cloud_predictor.deploy()
            result = cloud_predictor.predict_real_time(test_data)
            cloud_predictor.cleanup_deployment()
            # Batch inference
            result = cloud_predictor.predict(test_data)
            return result 
        except Exception as e:
            return "Something went wrong."


async def main():
    # context manager for start/stop of the session
    async with CodeInterpreterSession(additional_tools=[AutoGluonTabular()]) as session:
        # define the user request
        user_request = "train and evaluate the 'class' label using this training dataset: https://autogluon.s3.amazonaws.com/datasets/Inc/train.csv and this test dataset https://autogluon.s3.amazonaws.com/datasets/Inc/test.csv."
        
        response = await session.agenerate_response(user_request)

        # output the response (text + image)
        response.show()


if __name__ == "__main__":
    import asyncio

    # run the async function
    asyncio.run(main())

